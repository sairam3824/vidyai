version: "3.9"

# ── Production override ────────────────────────────────────────────────────────
# Use with:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# On AWS EC2/ECS, DATABASE_URL should point to RDS.
# The frontend points to your API Gateway or ALB domain.

services:
  backend:
    restart: always
    command: >
      sh -c "alembic upgrade head &&
             uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4"
    environment:
      DEBUG: "false"
      ENVIRONMENT: production
      STORAGE_MODE: s3
      # Override these via EC2 environment or AWS Secrets Manager:
      # DATABASE_URL: postgresql://user:pass@rds-endpoint:5432/edusaas
      # SECRET_KEY: <strong-secret>
      # OPENAI_API_KEY: sk-...
      # AWS_ACCESS_KEY_ID: ...
      # AWS_SECRET_ACCESS_KEY: ...
      # S3_BUCKET_NAME: edusaas-textbooks
      ALLOWED_ORIGINS: '["https://yourdomain.com"]'
    volumes: []  # no bind mounts in production

  frontend:
    restart: always
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: https://api.yourdomain.com/api/v1
