version: "3.9"

# ── Production-equivalent local development stack ──────────────────────────────
# DB + Auth: Supabase (cloud) — no local PostgreSQL
# Backend:   FastAPI (port 8000)
# Worker:    Celery (PDF ingestion)
# Cache/Queue: Redis (port 6379)
#
# Usage:
#   cp backend/.env.example backend/.env   # fill in Supabase + AWS + OpenAI keys
#   docker compose up --build

services:
  # ── Redis (cache + Celery broker) ──────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: vidyai-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redisdata:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ── FastAPI backend ────────────────────────────────────────────────────────
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vidyai-backend
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    env_file:
      - ./backend/.env
    environment:
      REDIS_URL: redis://redis:6379/0
      ALLOWED_ORIGINS: '["https://vidyaiedtech.saiii.in","https://vidyai-zeta.vercel.app","http://localhost:3000"]'
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app          # hot-reload in dev
    command: >
      uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # ── Celery worker (PDF ingestion) ──────────────────────────────────────────
  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vidyai-worker
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    env_file:
      - ./backend/.env
    environment:
      REDIS_URL: redis://redis:6379/0
    volumes:
      - ./backend:/app
    command: >
      celery -A app.worker.celery_app worker
             --loglevel=info
             --concurrency=2
             -Q celery

volumes:
  redisdata:
